<%- include('../layouts/head.ejs') -%>

    <body>
        <%- include('../layouts/userNav.ejs') -%>

            <div class="mobile-header-active mobile-header-wrapper-style">
                <div class="mobile-header-wrapper-inner">
                    <div class="mobile-header-top">
                        <div class="mobile-header-logo">
                            <a href="index.html"><img src="assets/imgs/theme/logo.svg" alt="logo"></a>
                        </div>
                        <div class="mobile-menu-close close-style-wrap close-style-position-inherit">
                            <button class="close-style search-close">
                                <i class="icon-top"></i>
                                <i class="icon-bottom"></i>
                            </button>
                        </div>
                    </div>
                    <div class="mobile-header-content-area">
                        <div class="mobile-search search-style-3 mobile-header-border">
                            <form action="#">
                                <input type="text" placeholder="Search for items…">
                                <button type="submit"><i class="fi-rs-search"></i></button>
                            </form>
                        </div>
                        <div class="mobile-menu-wrap mobile-header-border">
                            <div class="main-categori-wrap mobile-header-border">
                                <a class="categori-button-active-2" href="#">
                                    <span class="fi-rs-apps"></span> Browse Categories
                                </a>
                                <div class="categori-dropdown-wrap categori-dropdown-active-small">
                                    <ul>
                                        <li><a href="shop-grid-right.html"><i class="evara-font-dress"></i>Women's
                                                Clothing</a></li>
                                        <li><a href="shop-grid-right.html"><i class="evara-font-tshirt"></i>Men's
                                                Clothing</a></li>
                                        <li> <a href="shop-grid-right.html"><i class="evara-font-smartphone"></i>
                                                Cellphones</a></li>
                                        <li><a href="shop-grid-right.html"><i class="evara-font-desktop"></i>Computer &
                                                Office</a></li>
                                        <li><a href="shop-grid-right.html"><i class="evara-font-cpu"></i>Consumer
                                                Electronics</a></li>
                                        z <li><a href="shop-grid-right.html"><i class="evara-font-home"></i>Home &
                                                Garden</a></li>
                                        <li><a href="shop-grid-right.html"><i
                                                    class="evara-font-high-heels"></i>Shoes</a></li>
                                        <li><a href="shop-grid-right.html"><i class="evara-font-teddy-bear"></i>Mother &
                                                Kids</a></li>
                                        <li><a href="shop-grid-right.html"><i class="evara-font-kite"></i>Outdoor
                                                fun</a></li>
                                    </ul>
                                </div>
                            </div>
                            <!-- mobile menu start -->
                            <nav>
                                <ul class="mobile-menu">
                                    <li class="menu-item-has-children"><span class="menu-expand"></span><a
                                            href="index.html">Home</a>
                                        <ul class="dropdown">
                                            <li><a href="index.html">Home 1</a></li>
                                            <li><a href="index-2.html">Home 2</a></li>
                                            <li><a href="index-3.html">Home 3</a></li>
                                            <li><a href="index-4.html">Home 4</a></li>
                                        </ul>
                                    </li>
                                    <li class="menu-item-has-children"><span class="menu-expand"></span><a
                                            href="shop-grid-right.html">shop</a>
                                        <ul class="dropdown">
                                            <li><a href="shop-grid-right.html">Shop Grid – Right Sidebar</a></li>
                                            <li><a href="shop-grid-left.html">Shop Grid – Left Sidebar</a></li>
                                            <li><a href="shop-list-right.html">Shop List – Right Sidebar</a></li>
                                            <li><a href="shop-list-left.html">Shop List – Left Sidebar</a></li>
                                            <li><a href="shop-fullwidth.html">Shop - Wide</a></li>
                                            <li class="menu-item-has-children"><span class="menu-expand"></span><a
                                                    href="#">Single Product</a>
                                                <ul class="dropdown">
                                                    <li><a href="shop-product-right.html">Product – Right Sidebar</a>
                                                    </li>
                                                    <li><a href="shop-product-left.html">Product – Left Sidebar</a></li>
                                                    <li><a href="shop-product-full.html">Product – No sidebar</a></li>
                                                </ul>
                                            </li>
                                            <li><a href="shop-filter.html">Shop – Filter</a></li>
                                            <li><a href="shop-wishlist.html">Shop – Wishlist</a></li>
                                            <li><a href="shop-cart.html">Shop – Cart</a></li>
                                            <li><a href="shop-checkout.html">Shop – Checkout</a></li>
                                            <li><a href="shop-compare.html">Shop – Compare</a></li>
                                        </ul>
                                    </li>
                                    <li class="menu-item-has-children"><span class="menu-expand"></span><a href="#">Mega
                                            menu</a>
                                        <ul class="dropdown">
                                            <li class="menu-item-has-children"><span class="menu-expand"></span><a
                                                    href="#">Women's Fashion</a>
                                                <ul class="dropdown">
                                                    <li><a href="shop-product-right.html">Dresses</a></li>
                                                    <li><a href="shop-product-right.html">Blouses & Shirts</a></li>
                                                    <li><a href="shop-product-right.html">Hoodies & Sweatshirts</a></li>
                                                    <li><a href="shop-product-right.html">Women's Sets</a></li>
                                                </ul>
                                            </li>
                                            <li class="menu-item-has-children"><span class="menu-expand"></span><a
                                                    href="#">Men's Fashion</a>
                                                <ul class="dropdown">
                                                    <li><a href="shop-product-right.html">Jackets</a></li>
                                                    <li><a href="shop-product-right.html">Casual Faux Leather</a></li>
                                                    <li><a href="shop-product-right.html">Genuine Leather</a></li>
                                                </ul>
                                            </li>
                                            <li class="menu-item-has-children"><span class="menu-expand"></span><a
                                                    href="#">Technology</a>
                                                <ul class="dropdown">
                                                    <li><a href="shop-product-right.html">Gaming Laptops</a></li>
                                                    <li><a href="shop-product-right.html">Ultraslim Laptops</a></li>
                                                    <li><a href="shop-product-right.html">Tablets</a></li>
                                                    <li><a href="shop-product-right.html">Laptop Accessories</a></li>
                                                    <li><a href="shop-product-right.html">Tablet Accessories</a></li>
                                                </ul>
                                            </li>
                                        </ul>
                                    </li>
                                    <li class="menu-item-has-children"><span class="menu-expand"></span><a
                                            href="blog-category-fullwidth.html">Blog</a>
                                        <ul class="dropdown">
                                            <li><a href="blog-category-grid.html">Blog Category Grid</a></li>
                                            <li><a href="blog-category-list.html">Blog Category List</a></li>
                                            <li><a href="blog-category-big.html">Blog Category Big</a></li>
                                            <li><a href="blog-category-fullwidth.html">Blog Category Wide</a></li>
                                            <li class="menu-item-has-children"><span class="menu-expand"></span><a
                                                    href="#">Single Product Layout</a>
                                                <ul class="dropdown">
                                                    <li><a href="blog-post-left.html">Left Sidebar</a></li>
                                                    <li><a href="blog-post-right.html">Right Sidebar</a></li>
                                                    <li><a href="blog-post-fullwidth.html">No Sidebar</a></li>
                                                </ul>
                                            </li>
                                        </ul>
                                    </li>
                                    <li class="menu-item-has-children"><span class="menu-expand"></span><a
                                            href="#">Pages</a>
                                        <ul class="dropdown">
                                            <li><a href="page-about.html">About Us</a></li>
                                            <li><a href="page-contact.html">Contact</a></li>
                                            <li><a href="page-account.html">My Account</a></li>
                                            <li><a href="page-login-register.html">login/register</a></li>
                                            <li><a href="page-purchase-guide.html">Purchase Guide</a></li>
                                            <li><a href="page-privacy-policy.html">Privacy Policy</a></li>
                                            <li><a href="page-terms.html">Terms of Service</a></li>
                                            <li><a href="page-404.html">404 Page</a></li>
                                        </ul>
                                    </li>
                                    <li class="menu-item-has-children"><span class="menu-expand"></span><a
                                            href="#">Language</a>
                                        <ul class="dropdown">
                                            <li><a href="#">English</a></li>
                                            <li><a href="#">French</a></li>
                                            <li><a href="#">German</a></li>
                                            <li><a href="#">Spanish</a></li>
                                        </ul>
                                    </li>
                                </ul>
                            </nav>
                            <!-- mobile menu end -->
                        </div>
                        <div class="mobile-header-info-wrap mobile-header-border">
                            <div class="single-mobile-header-info mt-30">
                                <a href="page-contact.html"> Our location </a>
                            </div>
                            <div class="single-mobile-header-info">
                                <a href="page-login-register.html">Log In / Sign Up </a>
                            </div>
                            <div class="single-mobile-header-info">
                                <a href="#">(+01) - 2345 - 6789 </a>
                            </div>
                        </div>
                        <div class="mobile-social-icon">
                            <h5 class="mb-15 text-grey-4">Follow Us</h5>
                            <a href="#"><img src="assets/imgs/theme/icons/icon-facebook.svg" alt=""></a>
                            <a href="#"><img src="assets/imgs/theme/icons/icon-twitter.svg" alt=""></a>
                            <a href="#"><img src="assets/imgs/theme/icons/icon-instagram.svg" alt=""></a>
                            <a href="#"><img src="assets/imgs/theme/icons/icon-pinterest.svg" alt=""></a>
                            <a href="#"><img src="assets/imgs/theme/icons/icon-youtube.svg" alt=""></a>
                        </div>
                    </div>
                </div>
            </div>
            <main class="main">
                <div class="page-header breadcrumb-wrap">
                    <div class="container">
                        <div class="breadcrumb">
                            <a href="index.html" rel="nofollow">Home</a>
                            <span></span> Shop
                            <span></span> Your Cart
                        </div>
                    </div>
                </div>
                <section class="mt-50 mb-50">
                    <div class="container">
                        <div class="row">
                            <div class="col-12">
                                <div class="table-responsive">
                                    <% let totalSubTotal=0 %>

                                        <% if (cart.length> 0) { %>
                                            <table class="table shopping-summery text-center clean">
                                                <thead>
                                                    <tr class="main-heading">
                                                        <th scope="col">Image</th>
                                                        <th scope="col">Name</th>
                                                        <th scope="col">Price</th>
                                                        <th scope="col">Quantity</th>
                                                        <th scope="col">Subtotal</th>
                                                        <th scope="col">Remove</th>
                                                    </tr>
                                                </thead>
                                                <tbody>

                                                    <% for( let i=0; i < products.length; i++ ) { %>



                                                        <tr>
                                                            <td class="image product-thumbnail"><img
                                                                    src="/admin-asset/productImage/<%=products[i].image[0].filename %>"
                                                                    alt="product image" alt="#"></td>
                                                            <td class="product-des product-name">
                                                                <h5 class="product-name"><a
                                                                        href="shop-product-right.html">
                                                                        <%=products[i].productName %>
                                                                    </a></h5>
                                                                <p class="font-xs">Maboriosam in a tonto nesciung
                                                                    eget<br> distingy magndapibus.
                                                                </p>
                                                            </td>
                                                            <td class="price" data-title="Price"><span>$<%=
                                                                        products[i].salePrice %> </span></td>
                                                            <td class="text-center" data-title="Stock">
                                                                <button class="btn btn-sm increment-button"
                                                                    onclick="updateQuantity('qtyInc', '<%= products[i]._id %>', '<%= i %>')">+</button>
                                                                <input class="quantity-input<%= i %>"
                                                                    id="cartProductqty<%= i %>" style="width: 45px;"
                                                                    type="text" readonly value="<%= cart[i].quantity %>"
                                                                    data-product-index="<%= i %>">
                                                                <button class="btn btn-sm decrement-button"
                                                                    onclick="updateQuantity('qtyDec', '<%= products[i]._id %>', '<%= i %>')">-</button>
                                                            </td>



                                                            <td class="text-right" data-title="Cart">



                                                                <span id="subtotal<%= i %>">
                                                                    <%= (products[i].salePrice *
                                                                        cart[i].quantity).toFixed(2) %>
                                                                </span>
                                                            </td>

                                                            <td class="action" data-title="Remove"><a
                                                                    class="text-danger"
                                                                    onclick="confirmDelete('<%= products[i]._id %>')"><i
                                                                        class="fi-rs-trash"></i></a></td>

                                                        </tr>
                                                        <% totalSubTotal +=parseFloat(products[i].salePrice *
                                                            cart[i].quantity) %>
                                                            <% } %>


                                                </tbody>

                                            </table>
                                            <% } else { %>
                                                <div class="container mt-5">
                                                    <div class=" text-center">
                                                        <img src="/assets/imgs/page/download.png"
                                                            alt="Empty Cart Image">
                                                        <p>Uh-oh! Your cart is feeling a bit lonely.</p>
                                                        <p>Time to fill it up with amazing finds!</p>
                                                        <a href="/home" class="btn btn-primary">Add to Cart</a>
                                                    </div>
                                                </div>

                                                <% } %>
                                </div>
                                <div class="cart-action text-end">

                                    <a class="btn " href="/home"><i class="fi-rs-shopping-bag mr-10"></i>Continue
                                        Shopping</a>
                                </div>
                                <% if (typeof message !=='undefined' ) { %>
                                    <p class="text-center" style="color: rgb(255, 0, 0) ">
                                        <%= message %>
                                    </p>
                                    <% } %>

                                        <div class="divider center_icon mt-50 mb-50"><i class="fi-rs-fingerprint"></i>
                                        </div>
                                        <div class="row mb-50">

                                            <div class="col-lg-6 col-md-12">
                                                <div class="border p-md-4 p-30 border-radius cart-totals">
                                                    <div class="heading_s1 mb-3">
                                                        <h4>Cart Totals</h4>
                                                    </div>
                                                    <div class="table-responsive">
                                                        <table class="table">
                                                            <tbody>
                                                                <tr>
                                                                    <td class="cart_total_label">sub Total</td>

                                                                    <td class="cart_total_amount"><span
                                                                            class="font-lg fw-900 text-brand">$ <%=
                                                                                totalSubTotal.toFixed(2) %></span></td>
                                                                </tr>
                                                                <tr>
                                                                    <td class="cart_total_label">Shipping</td>
                                                                    <td class="cart_total_amount"> <i
                                                                            class="ti-gift mr-5"></i> Free Shipping</td>
                                                                </tr>
                                                                <!-- <tr>
                                                    <td class="cart_total_label">Total</td>
                                                    <td class="cart_total_amount"><strong><span class="font-xl fw-900 text-brand">$ <%= totalSubTotal.toFixed(2) %></span></strong></td>
                                                </tr> -->
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                    <a href="/checkout" class="btn "> <i
                                                            class="fi-rs-box-alt mr-10"></i> Proceed To CheckOut</a>
                                                </div>
                                            </div>
                                        </div>
                            </div>
                        </div>
                    </div>
                </section>
            </main>
            <%- include("../layouts/userFooter.ejs") -%>
                <!-- Preloader Start -->

                <!-- Include SweetAlert library -->
                <!-- Include SweetAlert -->
                <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

                <!-- Include jQuery -->
                <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
                <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
                <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

                <script>
                    function updateQuantity(action, productId, index) {
                        $.ajax({
                            type: 'POST',
                            url: `/cart/${action}?id=${productId}`,
                            success: function (data) {


                                if (!data || typeof data !== 'object') {
                                    console.error("Invalid data received from server.");
                                    return;
                                }

                                if (data.error) {
                                    // Handle specific errors
                                    if (data.error === "Out of stock") {
                                        Swal.fire({
                                            icon: "error",
                                            title: "Oops...",
                                            text: "This product is currently out of stock.",
                                        });
                                    } else {
                                        // Handle other errors
                                        console.log("product qty must be  one")
                                    }
                                    return;
                                }

                                const newQuantity = Math.max(1, data.quantity);

                                const cartProductQty = $(`#cartProductqty${index}`);
                                const priceElement = $(`#cartProductqty${index}`).closest('tr').find('.price span');

                                const salePriceStr = priceElement.text().replace('$', '').trim();

                                if (!salePriceStr) {
                                    console.error("Error: salePriceStr is null, undefined, or empty");
                                    return;
                                }

                                const salePrice = parseFloat(salePriceStr);

                                if (isNaN(salePrice)) {
                                    console.error("Error: salePrice is NaN");
                                } else {
                                    cartProductQty.val(newQuantity);
                                    const newSubtotal = (newQuantity * salePrice).toFixed(2);
                                    $(`#subtotal${index}`).text(newSubtotal);

                                    let totalSubTotal = 0;
                                    $('.text-right[data-title="Cart"] span').each(function () {
                                        totalSubTotal += parseFloat($(this).text());
                                    });

                                    $('.cart_total_amount span').text(`$${totalSubTotal.toFixed(2)}`);
                                }
                            },
                            error: function (xhr, status, error) {
                                console.error("Error updating quantity:", error);
                                const errorMessage = xhr.responseJSON ? xhr.responseJSON.error : "Unknown error";
                                Swal.fire({
                                    icon: "error",
                                    title: "Hello...",
                                    text: errorMessage,
                                });
                            }
                        });
                    }
                </script>







                <script>
                    function confirmDelete(productId) {
                        // Set up a Bootstrap modal for confirmation
                        const confirmationModal = new bootstrap.Modal(
                            document.getElementById("confirmationModal"),
                            {
                                backdrop: "static", // Prevent closing on click outside the modal
                                keyboard: false, // Prevent closing with the keyboard Esc key
                            }
                        );

                        // Display the modal
                        confirmationModal.show();

                        // Set up the delete button's click event to send a DELETE request
                        const deleteButton = document.getElementById("deleteButton");
                        deleteButton.addEventListener("click", async () => {
                            try {
                                // Send a DELETE request using the Fetch API
                                const response = await fetch(`/delete-cartItem?id=${productId}`, {
                                    method: "DELETE",
                                });

                                if (response.ok) {
                                    // Redirect or perform any other action after successful deletion
                                    window.location.href = "/cart";
                                } else {
                                    // Handle error response
                                    console.error("Error deleting cart item:", response.statusText);
                                }
                            } catch (error) {
                                console.error("Error deleting cart item:", error);
                            }
                        });
                    }
                </script>

                <div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel"
                    aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="confirmationModalLabel">Confirm Deletion</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <p>Are you sure you want to delete this item?</p>

                            </div>

                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <a id="deleteButton" href="" class="btn btn-danger">Delete</a>
                            </div>
                        </div>
                    </div>
                </div>



                <!-- Vendor JS-->
                <script src="assets/js/vendor/modernizr-3.6.0.min.js"></script>
                <script src="assets/js/vendor/jquery-3.6.0.min.js"></script>
                <script src="assets/js/vendor/jquery-migrate-3.3.0.min.js"></script>
                <script src="assets/js/vendor/bootstrap.bundle.min.js"></script>
                <script src="assets/js/plugins/slick.js"></script>
                <script src="assets/js/plugins/jquery.syotimer.min.js"></script>
                <script src="assets/js/plugins/wow.js"></script>
                <script src="assets/js/plugins/jquery-ui.js"></script>
                <script src="assets/js/plugins/perfect-scrollbar.js"></script>
                <script src="assets/js/plugins/magnific-popup.js"></script>
                <script src="assets/js/plugins/select2.min.js"></script>
                <script src="assets/js/plugins/waypoints.js"></script>
                <script src="assets/js/plugins/counterup.js"></script>
                <script src="assets/js/plugins/jquery.countdown.min.js"></script>
                <script src="assets/js/plugins/images-loaded.js"></script>
                <script src="assets/js/plugins/isotope.js"></script>
                <script src="assets/js/plugins/scrollup.js"></script>
                <script src="assets/js/plugins/jquery.vticker-min.js"></script>
                <!-- Template  JS -->
                <script src="assets/js/maind134.js?v=3.4"></script>
                <script src="assets/js/shopd134.js?v=3.4"></script>

                <%- include("../layouts/footer.ejs") -%>